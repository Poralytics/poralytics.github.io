const express = require('express');
const { asyncHandler } = require('../utils/error-handler');
const router = express.Router();
const { auth } = require('../middleware/auth');
const AutomatedPentesting = require('../services/automated-pentesting');

/**
 * POST /api/pentesting/:domainId/start
 * Start automated penetration test
 */
router.post('/:domainId/start', auth, async (req, res) => {
  try {
    const { domainId } = req.params;
    const { explicitConsent } = req.body;

    // Verify domain ownership
    const db = require('../config/database');
    const domain = db.prepare(
      'SELECT * FROM domains WHERE id = ? AND user_id = ?'
    ).get(domainId, req.user.id);

    if (!domain) {
      return res.status(404).json({
        success: false,
        error: 'Domain not found'
      });
    }

    // Verify consent
    if (!explicitConsent) {
      return res.status(400).json({
        success: false,
        error: 'Explicit consent required for penetration testing',
        message: 'You must explicitly consent to penetration testing by setting explicitConsent: true'
      });
    }

    // Start pentest
    const results = await AutomatedPentesting.runPentest(domainId, {
      explicitConsent: true
    });

    res.json({
      success: true,
      results
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

/**
 * GET /api/pentesting/:domainId/history
 * Get pentesting history
 */
router.get('/:domainId/history', auth, async (req, res) => {
  try {
    const { domainId } = req.params;

    const db = require('../config/database');
    
    // Verify ownership
    const domain = db.prepare(
      'SELECT * FROM domains WHERE id = ? AND user_id = ?'
    ).get(domainId, req.user.id);

    if (!domain) {
      return res.status(404).json({
        success: false,
        error: 'Domain not found'
      });
    }

    const history = db.prepare(`
      SELECT 
        id,
        status,
        safe_mode,
        started_at,
        completed_at
      FROM pentests
      WHERE domain_id = ?
      ORDER BY started_at DESC
      LIMIT 20
    `).all(domainId);

    res.json({
      success: true,
      history
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

/**
 * GET /api/pentesting/:pentestId/results
 * Get pentest results
 */
router.get('/:pentestId/results', auth, async (req, res) => {
  try {
    const { pentestId } = req.params;

    const db = require('../config/database');
    
    const pentest = db.prepare(`
      SELECT p.*, d.user_id
      FROM pentests p
      JOIN domains d ON p.domain_id = d.id
      WHERE p.id = ?
    `).get(pentestId);

    if (!pentest) {
      return res.status(404).json({
        success: false,
        error: 'Pentest not found'
      });
    }

    // Verify ownership
    if (pentest.user_id !== req.user.id) {
      return res.status(403).json({
        success: false,
        error: 'Access denied'
      });
    }

    const results = pentest.results ? JSON.parse(pentest.results) : null;

    res.json({
      success: true,
      pentest: {
        id: pentest.id,
        domainId: pentest.domain_id,
        status: pentest.status,
        safeMode: pentest.safe_mode === 1,
        startedAt: pentest.started_at,
        completedAt: pentest.completed_at,
        results
      }
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

/**
 * GET /api/pentesting/info
 * Get pentesting information and consent form
 */
router.get('/info', auth, async (req, res) => {
  try {
    res.json({
      success: true,
      info: {
        description: 'Automated Penetration Testing simulates real attacks on your system',
        safeMode: true,
        capabilities: [
          'Reconnaissance and information gathering',
          'Vulnerability discovery and categorization',
          'Safe exploitation simulation (read-only)',
          'Post-exploitation impact analysis',
          'Lateral movement simulation',
          'Financial impact assessment',
          'Exploit chain discovery'
        ],
        safety: [
          'Always runs in safe mode (read-only)',
          'No actual exploitation performed',
          'No system modifications',
          'Full audit trail',
          'Explicit consent required'
        ],
        consentRequired: true,
        consentText: 'I understand that this automated penetration test will simulate attacks on my system. I consent to NEXUS performing these tests in safe mode (read-only).'
      }
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

module.exports = router;
