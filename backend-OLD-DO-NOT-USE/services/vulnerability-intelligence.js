/**
 * VULNERABILITY INTELLIGENCE SERVICE
 * Enrichit les vulnérabilités avec données CVE/CWE/OWASP
 */

class VulnerabilityIntelligence {
  constructor() {
    this.cweDatabase = this.buildCWEDatabase();
    this.owaspMapping = this.buildOWASPMapping();
    this.cvssCalculator = new CVSSCalculator();
  }

  /**
   * Enrichit une vulnérabilité avec intelligence
   */
  enrich(vulnerability) {
    const enriched = { ...vulnerability };

    // OWASP Top 10 mapping
    if (!enriched.owasp_category) {
      enriched.owasp_category = this.mapToOWASP(enriched.category);
    }

    // CWE mapping
    if (!enriched.cwe_id) {
      enriched.cwe_id = this.mapToCWE(enriched.category, enriched.title);
    }

    // CVSS score calculation
    if (!enriched.cvss_score || enriched.cvss_score === 0) {
      enriched.cvss_score = this.calculateCVSS(enriched);
    }

    // Remediation
    if (!enriched.remediation_text) {
      enriched.remediation_text = this.getRemediation(enriched.category);
    }

    // Effort estimation
    if (!enriched.remediation_effort_hours) {
      enriched.remediation_effort_hours = this.estimateEffort(enriched);
    }

    return enriched;
  }

  mapToOWASP(category) {
    return this.owaspMapping[category] || 'A09:2021 - Security Logging and Monitoring Failures';
  }

  mapToCWE(category, title) {
    const mapping = {
      'SQL Injection': 'CWE-89',
      'Cross-Site Scripting (XSS)': 'CWE-79',
      'SSRF': 'CWE-918',
      'Command Injection': 'CWE-78',
      'XXE': 'CWE-611',
      'CSRF': 'CWE-352',
      'CORS': 'CWE-346',
      'Authentication': 'CWE-287',
      'Access Control': 'CWE-284',
      'Open Redirect': 'CWE-601',
      'Clickjacking': 'CWE-1021',
      'SSL/TLS': 'CWE-326',
      'Security Headers': 'CWE-693',
      'Information Disclosure': 'CWE-200',
      'Weak Cryptography': 'CWE-327',
      'File Upload': 'CWE-434'
    };
    return mapping[category] || 'CWE-Other';
  }

  calculateCVSS(vuln) {
    const baseScores = {
      critical: 9.5,
      high: 7.5,
      medium: 5.0,
      low: 2.5,
      info: 0.0
    };
    
    let score = baseScores[vuln.severity] || 5.0;
    
    // Ajustements
    if (vuln.parameter) score += 0.5; // Exploitable via paramètre
    if (vuln.evidence) score += 0.3; // Preuve concrète
    if (vuln.category === 'SQL Injection') score += 1.0; // Haute criticité
    if (vuln.category === 'Cross-Site Scripting (XSS)') score += 0.5;
    
    return Math.min(10.0, Math.max(0.0, score));
  }

  getRemediation(category) {
    const remediations = {
      'SQL Injection': 'Use parameterized queries or prepared statements. Never concatenate user input into SQL queries. Implement input validation and use ORM frameworks.',
      'Cross-Site Scripting (XSS)': 'Sanitize and encode all user input before rendering. Use Content Security Policy (CSP) headers. Implement context-aware output encoding.',
      'SSRF': 'Validate and whitelist allowed URLs/domains. Block access to internal IP ranges. Use DNS resolution checks before making requests.',
      'Command Injection': 'Avoid executing system commands with user input. Use safe APIs instead of shell commands. Implement strict input validation and whitelisting.',
      'XXE': 'Disable external entity processing in XML parsers. Use safe XML parsing configurations. Validate and sanitize XML input.',
      'CSRF': 'Implement anti-CSRF tokens in all state-changing operations. Use SameSite cookie attribute. Verify Origin/Referer headers.',
      'CORS': 'Configure CORS to whitelist specific trusted domains. Never use wildcard (*) with credentials. Implement proper access controls.',
      'Authentication': 'Implement rate limiting on authentication endpoints. Use strong password policies. Enable multi-factor authentication.',
      'Access Control': 'Implement proper authorization checks. Use role-based access control (RBAC). Never rely on client-side access control.',
      'Security Headers': 'Configure security headers: HSTS, CSP, X-Frame-Options, X-Content-Type-Options. Use helmet.js or similar libraries.'
    };
    return remediations[category] || 'Review security best practices for this vulnerability type.';
  }

  estimateEffort(vuln) {
    const effortMap = {
      critical: { min: 8, max: 40 },
      high: { min: 4, max: 16 },
      medium: { min: 2, max: 8 },
      low: { min: 1, max: 4 },
      info: { min: 0, max: 1 }
    };
    
    const range = effortMap[vuln.severity] || { min: 2, max: 8 };
    return Math.floor((range.min + range.max) / 2);
  }

  buildOWASPMapping() {
    return {
      'SQL Injection': 'A03:2021 - Injection',
      'Cross-Site Scripting (XSS)': 'A03:2021 - Injection',
      'SSRF': 'A10:2021 - Server-Side Request Forgery',
      'Command Injection': 'A03:2021 - Injection',
      'XXE': 'A05:2021 - Security Misconfiguration',
      'CSRF': 'A01:2021 - Broken Access Control',
      'CORS': 'A05:2021 - Security Misconfiguration',
      'Authentication': 'A07:2021 - Identification and Authentication Failures',
      'Access Control': 'A01:2021 - Broken Access Control',
      'Open Redirect': 'A01:2021 - Broken Access Control',
      'Clickjacking': 'A05:2021 - Security Misconfiguration',
      'SSL/TLS': 'A02:2021 - Cryptographic Failures',
      'Security Headers': 'A05:2021 - Security Misconfiguration',
      'Information Disclosure': 'A01:2021 - Broken Access Control',
      'Weak Cryptography': 'A02:2021 - Cryptographic Failures',
      'API Security': 'A08:2021 - Software and Data Integrity Failures'
    };
  }

  buildCWEDatabase() {
    return {
      'CWE-89': { name: 'SQL Injection', severity: 'critical' },
      'CWE-79': { name: 'Cross-site Scripting', severity: 'high' },
      'CWE-918': { name: 'Server-Side Request Forgery', severity: 'high' },
      'CWE-78': { name: 'OS Command Injection', severity: 'critical' },
      'CWE-611': { name: 'XML External Entity', severity: 'high' }
    };
  }
}

class CVSSCalculator {
  calculate(attackVector, attackComplexity, privilegesRequired, userInteraction, scope, confidentiality, integrity, availability) {
    // CVSS 3.1 formula simplified
    const AV = { N: 0.85, A: 0.62, L: 0.55, P: 0.2 }[attackVector] || 0.85;
    const AC = { L: 0.77, H: 0.44 }[attackComplexity] || 0.77;
    const PR = { N: 0.85, L: 0.62, H: 0.27 }[privilegesRequired] || 0.85;
    const UI = { N: 0.85, R: 0.62 }[userInteraction] || 0.85;
    const C = { H: 0.56, L: 0.22, N: 0 }[confidentiality] || 0.56;
    const I = { H: 0.56, L: 0.22, N: 0 }[integrity] || 0.56;
    const A = { H: 0.56, L: 0.22, N: 0 }[availability] || 0.56;

    const impact = 1 - ((1 - C) * (1 - I) * (1 - A));
    const exploitability = 8.22 * AV * AC * PR * UI;
    
    if (impact <= 0) return 0;
    
    const base = scope === 'U' 
      ? Math.min(10, (impact + exploitability))
      : Math.min(10, 1.08 * (impact + exploitability));
    
    return Math.round(base * 10) / 10;
  }
}

module.exports = new VulnerabilityIntelligence();
