<!-- USAGE WIDGET — Affiche quotas et encourage upgrades -->
<div class="usage-widget">
  <style>
    .usage-widget { background: #1a2332; border: 2px solid rgba(148,163,184,0.15); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; }
    .usage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .usage-title { font-size: 1.25rem; font-weight: 700; color: #f8fafc; }
    .plan-badge { padding: 0.5rem 1rem; background: linear-gradient(135deg, #1e40af, #6366f1); color: white; border-radius: 20px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; }
    .usage-item { margin-bottom: 1.25rem; }
    .usage-label { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; color: #cbd5e1; }
    .usage-progress { height: 8px; background: rgba(148, 163, 184, 0.2); border-radius: 4px; overflow: hidden; }
    .usage-progress-bar { height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); transition: width 0.6s ease; }
    .usage-progress-bar.warning { background: linear-gradient(90deg, #f59e0b, #ea580c); }
    .usage-progress-bar.danger { background: linear-gradient(90deg, #ef4444, #dc2626); }
    .upgrade-cta { margin-top: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(30, 64, 175, 0.2), rgba(99, 102, 241, 0.2)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; text-align: center; }
    .upgrade-cta-button { display: inline-block; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #1e40af, #6366f1); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; margin-top: 0.5rem; }
  </style>
  <div class="usage-header">
    <div class="usage-title">Your Usage</div>
    <div class="plan-badge" id="currentPlan">Loading...</div>
  </div>
  <div class="usage-items" id="usageItems"></div>
  <div class="upgrade-cta" id="upgradeCta" style="display:none;">
    <div style="font-weight:700;margin-bottom:0.5rem;">⚠️ You're almost at your limit!</div>
    <div>Upgrade now to continue scanning without interruption.</div>
    <a href="/pricing.html" class="upgrade-cta-button">Upgrade Plan</a>
  </div>
</div>
<script>
async function loadUsage() {
  try {
    const token = localStorage.getItem('token');
    if (!token) return;
    const res = await fetch('/api/usage', { headers: { 'Authorization': `Bearer ${token}` } });
    if (!res.ok) return;
    const data = await res.json();
    document.getElementById('currentPlan').textContent = data.plan.toUpperCase();
    const container = document.getElementById('usageItems');
    container.innerHTML = '';
    if (data.limits.domains !== -1) {
      container.innerHTML += `<div class="usage-item"><div class="usage-label"><span>Domains</span><span><strong>${data.usage.domains.used}</strong> / ${data.usage.domains.limit}</span></div><div class="usage-progress"><div class="usage-progress-bar ${data.usage.domains.percentage >= 90 ? 'danger' : data.usage.domains.percentage >= 80 ? 'warning' : ''}" style="width: ${data.usage.domains.percentage}%"></div></div></div>`;
    }
    if (data.limits.scans_per_month !== -1) {
      container.innerHTML += `<div class="usage-item"><div class="usage-label"><span>Scans this month</span><span><strong>${data.usage.scans.used}</strong> / ${data.usage.scans.limit}</span></div><div class="usage-progress"><div class="usage-progress-bar ${data.usage.scans.percentage >= 90 ? 'danger' : data.usage.scans.percentage >= 80 ? 'warning' : ''}" style="width: ${data.usage.scans.percentage}%"></div></div></div>`;
    }
    const highestUsage = Math.max(data.usage.domains.percentage || 0, data.usage.scans.percentage || 0);
    if (highestUsage >= 80) document.getElementById('upgradeCta').style.display = 'block';
  } catch (error) {
    console.error('Error loading usage:', error);
  }
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadUsage);
} else {
  loadUsage();
}
setInterval(loadUsage, 30000);
</script>
